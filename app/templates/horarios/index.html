{% extends 'layout.html' %}

{% block title %}Módulo de Horarios Especiales{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Encabezado de la sección -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h2">Módulo de Horarios Especiales</h1>
            <p class="text-muted">Configure excepciones a los horarios estándar para grupos o departamentos.</p>
        </div>
    </div>

    <!-- Mensajes Flash -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- Panel de Asignación de Horarios -->
    <div class="card shadow-sm mb-4">
        <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-edit me-2"></i>Asignar Horario Especial</h5>
        </div>
        <div class="card-body">
            <form action="{{ url_for('horarios.asignar') }}" method="POST">
                <div class="row g-3 align-items-end">
                    <!-- Selección de Grupo/Departamento -->
                    <div class="col-md-3">
                        <label class="form-label">Aplicar a:</label>
                        <select name="tipo" id="tipoSelector" class="form-select" required>
                            <option value="" selected disabled>Seleccionar...</option>
                            <option value="grupo">Grupo</option>
                            <option value="departamento">Departamento</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <div id="grupoSelectDiv" style="display: none;">
                            <label class="form-label">Grupo específico</label>
                            <select name="objeto_id_grupo" class="form-select">
                                {% for g in grupos %}<option value="{{ g.id }}">{{ g.name }}</option>{% endfor %}
                            </select>
                        </div>
                        <div id="deptoSelectDiv" style="display: none;">
                            <label class="form-label">Departamento específico</label>
                            <select name="objeto_id_depto" class="form-select">
                                {% for d in departamentos %}<option value="{{ d.id }}">{{ d.dept_name }}</option>{% endfor %}
                            </select>
                        </div>
                        <input type="hidden" name="objeto_id" id="objetoIdInput">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Fecha</label>
                        <input type="date" name="fecha" class="form-control" required>
                    </div>
                </div>
                <hr class="my-4">
                <!-- Pestañas de Acciones -->
                <div class="d-flex align-items-start">
                    <div class="nav flex-column nav-pills me-3" id="v-pills-tab" role="tablist" aria-orientation="vertical">
                        <button class="nav-link active" id="v-pills-entrada-tab" data-bs-toggle="pill" data-bs-target="#v-pills-entrada" type="button" role="tab" name="action" value="asignar_entrada"><i class="fas fa-sign-in-alt me-2"></i>Entrada Especial</button>
                        <button class="nav-link" id="v-pills-salida-tab" data-bs-toggle="pill" data-bs-target="#v-pills-salida" type="button" role="tab" name="action" value="asignar_salida"><i class="fas fa-sign-out-alt me-2"></i>Salida Especial</button>
                        <button class="nav-link" id="v-pills-extras-tab" data-bs-toggle="pill" data-bs-target="#v-pills-extras" type="button" role="tab" name="action" value="asignar_extras"><i class="fas fa-hourglass-half me-2"></i>Horas Extras</button>
                        <button class="nav-link" id="v-pills-feriado-tab" data-bs-toggle="pill" data-bs-target="#v-pills-feriado" type="button" role="tab" name="action" value="marcar_feriado"><i class="fas fa-calendar-check me-2"></i>Marcar Feriado</button>
                    </div>
                    <div class="tab-content flex-grow-1" id="v-pills-tabContent">
                        <div class="tab-pane fade show active" id="v-pills-entrada" role="tabpanel">
                            <label for="hora_entrada" class="form-label">Nueva Hora de Entrada</label>
                            <input type="time" name="hora_entrada" class="form-control mb-3" style="max-width: 200px;">
                        </div>
                        <div class="tab-pane fade" id="v-pills-salida" role="tabpanel">
                            <label for="hora_salida" class="form-label">Nueva Hora de Salida</label>
                            <input type="time" name="hora_salida" class="form-control mb-3" style="max-width: 200px;">
                        </div>
                        <div class="tab-pane fade" id="v-pills-extras" role="tabpanel">
                            <label for="horas_extras" class="form-label">Horas Extras Aprobadas</label>
                            <input type="number" name="horas_extras" class="form-control mb-3" step="1" min="0" value="0" style="max-width: 200px;">
                        </div>
                        <div class="tab-pane fade" id="v-pills-feriado" role="tabpanel">
                            <p>Esta acción marcará el día seleccionado como feriado para el grupo o departamento elegido.</p>
                        </div>
                        <button type="submit" class="btn btn-primary"><i class="fas fa-save me-2"></i>Guardar Cambio</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Filtros para las tablas -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="GET" class="row g-3 align-items-end">
                <div class="col-md-5"><label for="desde" class="form-label">Mostrar desde</label><input type="date" name="desde" id="desde" class="form-control" value="{{ desde or '' }}"></div>
                <div class="col-md-5"><label for="hasta" class="form-label">Mostrar hasta</label><input type="date" name="hasta" id="hasta" class="form-control" value="{{ hasta or '' }}"></div>
                <div class="col-md-2"><button type="submit" class="btn btn-secondary w-100">Filtrar</button></div>
            </form>
        </div>
    </div>

    <!-- Tablas de Registros Existentes -->
    <div class="row">
        <div class="col-lg-6">
            <div class="card shadow-sm">
                <div class="card-header"><h5 class="mb-0">Registros por Grupo</h5></div>
                <div class="card-body p-0">
                    <table class="table table-striped table-hover mb-0">
                        <thead><tr><th>Grupo</th><th>Fecha</th><th>Detalles</th><th class="text-end">Acción</th></tr></thead>
                        <tbody>
                            {% for hg in horarios_grupos.items %}
                            <tr>
                                <td><strong>{{ hg.grupo.name }}</strong></td>
                                <td>{{ hg.fecha.strftime('%d-%m-%Y') }}</td>
                                <td>
                                    {% if hg.feriado %}<span class="badge bg-danger">Feriado</span>{% endif %}
                                    {% if hg.hora_entrada_especial %}<span class="badge bg-info">Entrada: {{ hg.hora_entrada_especial.strftime('%H:%M') }}</span>{% endif %}
                                    {% if hg.hora_salida_especial %}<span class="badge bg-primary">Salida: {{ hg.hora_salida_especial.strftime('%H:%M') }}</span>{% endif %}
                                    {% if hg.horas_extras > 0 %}<span class="badge bg-success">Extras: {{ hg.horas_extras }}h</span>{% endif %}
                                </td>
                                <td class="text-end">
                                    <form action="{{ url_for('horarios.eliminar', tipo='grupo', registro_id=hg.id) }}" method="POST" onsubmit="return confirm('¿Eliminar este registro?')">
                                        <button type="submit" class="btn btn-sm btn-outline-danger"><i class="fas fa-trash-alt"></i></button>
                                    </form>
                                </td>
                            </tr>
                            {% else %}
                            <tr><td colspan="4" class="text-center text-muted p-4">No hay registros.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% if horarios_grupos.pages > 1 %}
                <div class="card-footer">
                    <nav><ul class="pagination pagination-sm justify-content-center mb-0">
                        {% for page_num in horarios_grupos.iter_pages() %}
                            <li class="page-item {% if page_num == horarios_grupos.page %}active{% endif %}">
                                <a class="page-link" href="{{ url_for('horarios.index', page=page_num, desde=desde, hasta=hasta) }}">{{ page_num }}</a>
                            </li>
                        {% endfor %}
                    </ul></nav>
                </div>
                {% endif %}
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card shadow-sm">
                <div class="card-header"><h5 class="mb-0">Registros por Departamento</h5></div>
                <div class="card-body p-0">
                    <table class="table table-striped table-hover mb-0">
                         <thead><tr><th>Departamento</th><th>Fecha</th><th>Detalles</th><th class="text-end">Acción</th></tr></thead>
                        <tbody>
                            {% for hd in horarios_departamentos.items %}
                            <tr>
                                <td><strong>{{ hd.dept_name }}</strong></td>
                                <td>{{ hd.fecha.strftime('%d-%m-%Y') }}</td>
                                <td>
                                    {% if hd.feriado %}<span class="badge bg-danger">Feriado</span>{% endif %}
                                    {% if hd.hora_entrada_especial %}<span class="badge bg-info">Entrada: {{ hd.hora_entrada_especial.strftime('%H:%M') }}</span>{% endif %}
                                    {% if hd.hora_salida_especial %}<span class="badge bg-primary">Salida: {{ hd.hora_salida_especial.strftime('%H:%M') }}</span>{% endif %}
                                    {% if hd.horas_extras > 0 %}<span class="badge bg-success">Extras: {{ hd.horas_extras }}h</span>{% endif %}
                                </td>
                                <td class="text-end">
                                    <form action="{{ url_for('horarios.eliminar', tipo='departamento', registro_id=hd.id) }}" method="POST" onsubmit="return confirm('¿Eliminar este registro?')">
                                        <button type="submit" class="btn btn-sm btn-outline-danger"><i class="fas fa-trash-alt"></i></button>
                                    </form>
                                </td>
                            </tr>
                            {% else %}
                            <tr><td colspan="4" class="text-center text-muted p-4">No hay registros.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                 {% if horarios_departamentos.pages > 1 %}
                <div class="card-footer">
                    <nav><ul class="pagination pagination-sm justify-content-center mb-0">
                        {% for page_num in horarios_departamentos.iter_pages() %}
                            <li class="page-item {% if page_num == horarios_departamentos.page %}active{% endif %}">
                                <a class="page-link" href="{{ url_for('horarios.index', page=page_num, desde=desde, hasta=hasta) }}">{{ page_num }}</a>
                            </li>
                        {% endfor %}
                    </ul></nav>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const tipoSelector = document.getElementById('tipoSelector');
    const grupoDiv = document.getElementById('grupoSelectDiv');
    const deptoDiv = document.getElementById('deptoSelectDiv');
    const objetoIdInput = document.getElementById('objetoIdInput');
    const grupoSelect = grupoDiv.querySelector('select');
    const deptoSelect = deptoDiv.querySelector('select');

    function toggleSelectors() {
        const selectedType = tipoSelector.value;
        grupoDiv.style.display = selectedType === 'grupo' ? 'block' : 'none';
        deptoDiv.style.display = selectedType === 'departamento' ? 'block' : 'none';

        // Sincronizar el valor del select visible con el input oculto
        if (selectedType === 'grupo') {
            objetoIdInput.value = grupoSelect.value;
        } else if (selectedType === 'departamento') {
            objetoIdInput.value = deptoSelect.value;
        }
    }

    tipoSelector.addEventListener('change', toggleSelectors);
    grupoSelect.addEventListener('change', () => { objetoIdInput.value = grupoSelect.value; });
    deptoSelect.addEventListener('change', () => { objetoIdInput.value = deptoSelect.value; });

    // Sincronizar el botón de envío con la acción seleccionada
    const actionButtons = document.querySelectorAll('#v-pills-tab button');
    const mainForm = document.querySelector('form[action="{{ url_for('horarios.asignar') }}"]');

    actionButtons.forEach(button => {
        button.addEventListener('click', function() {
            // Eliminar si existe un input de acción previo
            const existingActionInput = mainForm.querySelector('input[name="action"]');
            if (existingActionInput) {
                existingActionInput.remove();
            }
            // Crear un nuevo input oculto con la acción correcta
            const actionInput = document.createElement('input');
            actionInput.type = 'hidden';
            actionInput.name = 'action';
            actionInput.value = this.value;
            mainForm.appendChild(actionInput);
        });
    });

    // Inicializar el estado al cargar la página
    toggleSelectors();
    // Establecer la acción inicial
    document.querySelector('#v-pills-tab button.active').click();
});
</script>
{% endblock %}
